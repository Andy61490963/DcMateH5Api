name: Deploy DcMateH5Api to IIS (Self-hosted)

on:
  push:
    branches: [ "main" ]

env:
  PROJECT_PATH: "DcMateH5Api.csproj"
  PUBLISH_DIR: "C:\\CICDDeploy\\publish"
  IIS_PHYSICAL_PATH: "C:\\inetpub\\wwwroot\\測試"
  IIS_APP_POOL: "DcMateH5Api"

jobs:
  deploy:
    runs-on: [self-hosted, Windows, iis, dcmate]

    steps:
      - uses: actions/checkout@v4

      - name: Publish
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          dotnet restore "$env:PROJECT_PATH"
          dotnet publish "$env:PROJECT_PATH" -c Release -o "$env:PUBLISH_DIR"

      - name: Deploy
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          Import-Module WebAdministration

          $target  = $env:IIS_PHYSICAL_PATH
          $offline = Join-Path $target "app_offline.htm"

          "Deploying..." | Out-File $offline -Encoding utf8 -Force
          Stop-WebAppPool -Name $env:IIS_APP_POOL -ErrorAction SilentlyContinue

          robocopy "$env:PUBLISH_DIR" "$target" /MIR /R:2 /W:2 /XF "*.pdb" /XD "SecurityKeys"
          if ($LASTEXITCODE -ge 8) { throw "Robocopy failed: $LASTEXITCODE" }
          $global:LASTEXITCODE = 0

          Remove-Item $offline -Force -ErrorAction SilentlyContinue
          Start-WebAppPool -Name $env:IIS_APP_POOL -ErrorAction SilentlyContinue
