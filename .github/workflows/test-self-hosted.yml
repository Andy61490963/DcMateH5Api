name: Deploy DcMateH5Api to IIS (Self-hosted)

on:
  workflow_dispatch: {}

env:
  PROJECT_PATH: "DcMateH5Api.csproj"
  DEPLOY_ROOT: "C:\\CICDDeploy"
  PUBLISH_DIR: "C:\\CICDDeploy\\publish"
  IIS_PHYSICAL_PATH: "C:\\inetpub\\wwwroot\\測試"
  IIS_APP_POOL: "DcMateH5Api"

jobs:
  deploy:
    runs-on: [self-hosted, Windows, iis, dcmate]

    steps:
      - name: Ensure pwsh path for Actions
        shell: powershell
        run: |
          $ps7 = Join-Path "$env:ProgramFiles\PowerShell\7" "pwsh.exe"
          if (!(Test-Path $ps7)) { throw "pwsh.exe not found at: $ps7" }
          Split-Path $ps7 | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          & $ps7 -NoLogo -NoProfile -Command '$PSVersionTable.PSVersion'
          where.exe pwsh

      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure folders
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          foreach ($p in @($env:DEPLOY_ROOT, $env:PUBLISH_DIR, $env:IIS_PHYSICAL_PATH)) {
            if (!(Test-Path $p)) { New-Item -ItemType Directory -Path $p | Out-Null }
          }
          Write-Host "PUBLISH_DIR: $env:PUBLISH_DIR"
          Write-Host "IIS_PATH   : $env:IIS_PHYSICAL_PATH"

      - name: Publish (Release)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          dotnet --info
          dotnet restore $env:PROJECT_PATH
          dotnet build   $env:PROJECT_PATH -c Release --no-restore

          Remove-Item "$env:PUBLISH_DIR\*" -Recurse -Force -ErrorAction SilentlyContinue
          dotnet publish $env:PROJECT_PATH -c Release -o $env:PUBLISH_DIR --no-build

      - name: Deploy to IIS
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Import-Module WebAdministration -SkipEditionCheck -ErrorAction Stop

          $publish = $env:PUBLISH_DIR
          $target  = $env:IIS_PHYSICAL_PATH
          $pool    = $env:IIS_APP_POOL

          $offline = Join-Path $target "app_offline.htm"

          try {
            # 1) offline（最關鍵：解鎖 dll）
            "Deploying... Please wait." | Out-File -FilePath $offline -Encoding utf8

            # 2) stop pool
            Stop-WebAppPool -Name $pool -ErrorAction SilentlyContinue

            # 3) copy（注意：robocopy exit code 要自己判斷）
            robocopy "$publish" "$target" /MIR /R:2 /W:2 /NFL /NDL /NP /XF "*.pdb"
            $rc = $LASTEXITCODE
            if ($rc -ge 8) { throw "Robocopy failed. ExitCode=$rc" }

            # ✅ 吃掉 robocopy 的非 0（不然 Actions 會當失敗）
            $global:LASTEXITCODE = 0

            # 4) remove offline
            if (Test-Path $offline) { Remove-Item $offline -Force }

            # 5) start pool
            Start-WebAppPool -Name $pool
            Write-Host "Deploy done."
          }
          finally {
            # 失敗也不要卡 offline
            if (Test-Path $offline) { Remove-Item $offline -Force -ErrorAction SilentlyContinue }
          }
